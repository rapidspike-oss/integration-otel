# RapidSpike User Journey -> One Journey Results
# -------------------------------------------
# Fetches journey test results including timings, errors, and pass/fail state.
# Replace {{journey-uuid}} with your Journey ID.
#
# Authentication:
#   - Recommended: use a signed proxy endpoint that performs HMAC signing on your behalf.
#   - Alternative: use a manually pre-signed URL for short-term testing.
#
# Environment variables:
#   RAPIDSPIKE_PROXY_URL     -> (Optional) your signed proxy endpoint base, e.g. https://proxy.example.com
#   RAPIDSPIKE_BASE_URL      -> (Optional) defaults to https://api.rapidspike.com
#   RAPIDSPIKE_PUBLIC_KEY    -> Your RapidSpike public key
#   RAPIDSPIKE_PRIVATE_KEY   -> Your RapidSpike private key (used only by proxy or pre-sign script)

receivers:
  rapidspike_journey:

    # Option 1 – Recommended: use a signed proxy that performs HMAC signing
    endpoint: "${RAPIDSPIKE_PROXY_URL}/v1/journeys/{{journey-uuid}}/samples?page=1&per_page=1"

    # Option 2 – Pre-signed URL (generated with your HMAC script):
    # endpoint: "${RAPIDSPIKE_BASE_URL}/v1/journeys/{{journey-uuid}}/samples?page=1&per_page=1&regions=&public_key=${RAPIDSPIKE_PUBLIC_KEY}&time=${RAPIDSPIKE_TIME}&signature=${RAPIDSPIKE_SIGNATURE}"

    method: GET
    collection_interval: 5m

    parsing:
      json:
        path: "data.samples"
        metrics:
          - name: rapidspike.journey.total_time_ms
            type: gauge
            value_field: "TotalTime"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"
              comment: "Comment"
          - name: rapidspike.journey.step_time_ms
            type: gauge
            value_field: "StepTime"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"
          - name: rapidspike.journey.dom_time_ms
            type: gauge
            value_field: "DomTime"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"
          - name: rapidspike.journey.load_time_ms
            type: gauge
            value_field: "LoadTime"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"
          - name: rapidspike.journey.render_time_ms
            type: gauge
            value_field: "RenderTime"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"
          - name: rapidspike.journey.errors_total
            type: gauge
            value_field: "ErrorsCount"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"
          - name: rapidspike.journey.error_breakdown_total
            type: gauge
            value_field: "ErrorBreakdown.total"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"
          - name: rapidspike.journey.error_breakdown_errors
            type: gauge
            value_field: "ErrorBreakdown.errors"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"
          - name: rapidspike.journey.error_breakdown_warnings
            type: gauge
            value_field: "ErrorBreakdown.warnings"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"
          - name: rapidspike.journey.error_breakdown_failures
            type: gauge
            value_field: "ErrorBreakdown.failures"
            attributes:
              region: "RunRegionData.label"
              browser: "Browser"

processors:
  batch:
    timeout: 30s
  resourcedetection:
    detectors: [ env, system ]

exporters:
  otlphttp:
    endpoint: "https://otel.rapidspike.com/v1/metrics"
    headers:
      x-api-key: "${RAPIDSPIKE_PUBLIC_KEY}"

service:
  pipelines:
    metrics:
      receivers: [ rapidspike_journey ]
      processors: [ batch, resourcedetection ]
      exporters: [ otlphttp ]
