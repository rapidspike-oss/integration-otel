# RapidSpike Sitemaps -> One Sitemap Tests Results
# -------------------------------------------
# Fetches individual URL test results from a single Bulk URL Monitor test.
# Replace {{bulk-url-uuid}} with your sitemap ID.
#
# Authentication:
#   - Recommended: use a signed proxy endpoint that performs HMAC signing on your behalf.
#   - Alternative: use a manually pre-signed URL for short-term testing.
#
# Environment variables:
#   RAPIDSPIKE_PROXY_URL     -> (Optional) your signed proxy endpoint base, e.g. https://proxy.example.com
#   RAPIDSPIKE_BASE_URL      -> (Optional) defaults to https://api.rapidspike.com
#   RAPIDSPIKE_PUBLIC_KEY    -> Your RapidSpike public key
#   RAPIDSPIKE_PRIVATE_KEY   -> Your RapidSpike private key (used only by proxy or pre-sign script)

receivers:
  rapidspike_journey:

    # Option 1 – Recommended: use a signed proxy that performs HMAC signing
    endpoint: "${RAPIDSPIKE_PROXY_URL}/v1/bulkurlmonitor/{{bulk-url-uuid}}/tests/{{test-uuid}}?filter_by_response_codes=403,404&filter_by_response_codes_condition=greater_than_or_equal_to&filter_by_url=^https?:\/\/www\\.example\\.com\\/product\\/widget-[0-9]+\\.html$&filter_by_no_response=yes&limit=50&per_page=25&page=1&sort_by=response_code&order=desc"

    # Option 2 – Pre-signed URL (generated with your HMAC script):
    #endpoint: "${RAPIDSPIKE_BASE_URL}/v1/bulkurlmonitor/{{bulk-url-uuid}}/tests/{{test-uuid}}?filter_by_response_codes=403,404&filter_by_response_codes_condition=greater_than_or_equal_to&filter_by_url=^https?:\/\/www\\.example\\.com\\/product\\/widget-[0-9]+\\.html$&filter_by_no_response=yes&limit=50&per_page=25&page=1&sort_by=response_code&order=desc&public_key=${RAPIDSPIKE_PUBLIC_KEY}&time=${RAPIDSPIKE_TIME}&signature=${RAPIDSPIKE_SIGNATURE}"

    method: GET
      collection_interval: 24h
      parsing:
        json:
          path: "data.items"
          metrics:
            - name: rapidspike.bulkurl.response_time_ms
              type: gauge
              value_field: "response_time"
              attributes:
                region: "region.location"
                region_code: "region.token"
                url: "url"
                response_code: "response_code"
                unix_time: "unix_time"
            - name: rapidspike.bulkurl.response_code
              type: gauge
              value_field: "response_code"
              attributes:
                region: "region.location"
                region_code: "region.token"
                url: "url"
                unix_time: "unix_time"
            - name: rapidspike.bulkurl.url_count
              type: sum
              value_field: "url"
              aggregation: count
              attributes:
                region: "region.location"
                region_code: "region.token"
            - name: rapidspike.bulkurl.failed_responses
              type: sum
              calculation: "response_code >= 400 ? 1 : 0"
              attributes:
                region: "region.location"
                region_code: "region.token"

    processors:
      batch:
        timeout: 30s
      resourcedetection:
        detectors: [ env, system ]

    exporters:
      prometheus:
        endpoint: "0.0.0.0:9464"
      # Example alternate exporters:
      # otlphttp:
      #   endpoint: "https://otlp-gateway.grafana.net/otlp"
      #   headers:
      #     Authorization: "Bearer ${GRAFANA_CLOUD_API_KEY}"

    service:
      pipelines:
        metrics:
          receivers: [ rapidspike_bulkurlmonitor_testresults ]
          processors: [ batch, resourcedetection ]
          exporters: [ prometheus ]